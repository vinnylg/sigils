#!/bin/bash

# enx — USB ethernet interface manager
# List, query, and manage metrics for USB tethering interfaces

# ─── Constants ───────────────────────────────────────────────────────────────

ONBOARD_ETH_METRIC=50
ONBOARD_WIFI_METRIC=51

# ─── Helpers ─────────────────────────────────────────────────────────────────

_get_enx_interfaces() {
    ip -br -4 addr show | awk '/^enx/ {print $1}'
}

_get_ip() {
    local iface="$1"
    ip -br -4 addr show dev "$iface" 2>/dev/null | awk '{print $3}' | cut -d/ -f1
}

_get_metric() {
    local iface="$1"
    ip route show default dev "$iface" 2>/dev/null | grep -oP 'metric \K[0-9]+'
}

_get_gateway() {
    local iface="$1"
    ip route show default dev "$iface" 2>/dev/null | grep -oP 'via \K[0-9.]+'
    # If no gateway (direct route), empty is fine
}

_get_usb_device_name() {
    local iface="$1"
    local sys_path="/sys/class/net/${iface}/device"
    [[ -L "$sys_path" ]] || { echo "N/A"; return; }

    local real_path
    real_path=$(readlink -f "$sys_path")
    while [[ "$real_path" != "/" ]]; do
        if [[ -f "$real_path/product" ]]; then
            cat "$real_path/product"
            return
        fi
        real_path=$(dirname "$real_path")
    done
    echo "N/A"
}

_get_nm_connection() {
    local iface="$1"
    nmcli -g GENERAL.CONNECTION device show "$iface" 2>/dev/null
}

# ─── Interface resolution ────────────────────────────────────────────────────
# Resolves --name, --id, or --iface to an interface name.
# With a single interface, auto-selects if no selector given.

_resolve_interface() {
    local by_name="$1" by_id="$2" by_iface="$3"

    local interfaces
    mapfile -t interfaces < <(_get_enx_interfaces)

    if [[ ${#interfaces[@]} -eq 0 ]]; then
        echo "Error: no enx interfaces found." >&2
        return 1
    fi

    # Explicit selectors
    if [[ -n "$by_iface" ]]; then
        for iface in "${interfaces[@]}"; do
            [[ "$iface" == "$by_iface" ]] && { echo "$iface"; return 0; }
        done
        echo "Error: interface '$by_iface' not found." >&2
        return 1
    fi

    if [[ -n "$by_name" ]]; then
        local match=""
        for iface in "${interfaces[@]}"; do
            local dev_name
            dev_name=$(_get_usb_device_name "$iface")
            if [[ "${dev_name,,}" == *"${by_name,,}"* ]]; then
                if [[ -n "$match" ]]; then
                    echo "Error: ambiguous name '$by_name' matches multiple devices." >&2
                    return 1
                fi
                match="$iface"
            fi
        done
        if [[ -n "$match" ]]; then
            echo "$match"
            return 0
        fi
        echo "Error: no device matching '$by_name'." >&2
        return 1
    fi

    if [[ -n "$by_id" ]]; then
        if [[ -z "${interfaces[$by_id]}" ]]; then
            echo "Error: no interface at index $by_id." >&2
            return 1
        fi
        echo "${interfaces[$by_id]}"
        return 0
    fi

    # No selector: auto-select if single, else prompt
    if [[ ${#interfaces[@]} -eq 1 ]]; then
        echo "${interfaces[0]}"
        return 0
    fi

    echo "Multiple interfaces found. Specify --name, --id, or --iface:" >&2
    cmd_list >&2
    return 1
}

# ─── Commands ────────────────────────────────────────────────────────────────

cmd_list() {
    local interfaces
    mapfile -t interfaces < <(_get_enx_interfaces)

    if [[ ${#interfaces[@]} -eq 0 ]]; then
        echo "No enx interfaces found." >&2
        return 1
    fi

    local idx=0
    for iface in "${interfaces[@]}"; do
        local dev_name metric ip gw
        dev_name=$(_get_usb_device_name "$iface")
        metric=$(_get_metric "$iface")
        ip=$(_get_ip "$iface")
        gw=$(_get_gateway "$iface")
        echo "${dev_name:-N/A}"
        echo "  id:        $idx"
        echo "  interface: $iface"
        echo "  ip:        ${ip:-N/A}"
        echo "  gateway:   ${gw:-N/A}"
        echo "  metric:    ${metric:-N/A}"
        echo
        ((idx++))
    done
}

cmd_ip() {
    local iface
    iface=$(_resolve_interface "$SEL_NAME" "$SEL_ID" "$SEL_IFACE") || return 1

    local ip
    ip=$(_get_ip "$iface")
    if [[ -z "$ip" ]]; then
        echo "Error: no IPv4 address on $iface." >&2
        return 1
    fi
    echo "$ip"
}

cmd_pin_onboard() {
    local wifi_iface eth_iface

    # Find onboard interfaces (non-enx ethernet + wifi)
    eth_iface=$(nmcli -t -f DEVICE,TYPE device 2>/dev/null \
        | grep ':ethernet$' | cut -d: -f1 | grep -v '^enx' | head -1)
    wifi_iface=$(nmcli -t -f DEVICE,TYPE device 2>/dev/null \
        | grep ':wifi$' | cut -d: -f1 | head -1)

    local changed=0

    if [[ -n "$eth_iface" ]]; then
        local conn
        conn=$(_get_nm_connection "$eth_iface")
        if [[ -n "$conn" ]]; then
            echo "Pinning $eth_iface ($conn) → metric $ONBOARD_ETH_METRIC"
            nmcli connection modify "$conn" \
                ipv4.route-metric "$ONBOARD_ETH_METRIC" \
                ipv6.route-metric "$ONBOARD_ETH_METRIC"
            nmcli device reapply "$eth_iface" >/dev/null 2>&1
            ((changed++))
        fi
    else
        echo "Warning: no onboard ethernet found." >&2
    fi

    if [[ -n "$wifi_iface" ]]; then
        local conn
        conn=$(_get_nm_connection "$wifi_iface")
        if [[ -n "$conn" ]]; then
            echo "Pinning $wifi_iface ($conn) → metric $ONBOARD_WIFI_METRIC"
            nmcli connection modify "$conn" \
                ipv4.route-metric "$ONBOARD_WIFI_METRIC" \
                ipv6.route-metric "$ONBOARD_WIFI_METRIC"
            nmcli device reapply "$wifi_iface" >/dev/null 2>&1
            ((changed++))
        fi
    else
        echo "Warning: no wifi interface found." >&2
    fi

    if [[ $changed -gt 0 ]]; then
        echo
        echo "Default routes:"
        ip route show default
    fi
}

cmd_metric() {
    local iface
    iface=$(_resolve_interface "$SEL_NAME" "$SEL_ID" "$SEL_IFACE") || return 1

    if [[ -z "$METRIC_VALUE" ]]; then
        echo "Error: specify --value <metric>" >&2
        return 1
    fi

    if $PERMANENT; then
        local conn
        conn=$(_get_nm_connection "$iface")
        if [[ -z "$conn" ]]; then
            echo "Error: no NetworkManager connection for $iface." >&2
            return 1
        fi
        echo "Setting $iface ($conn) → metric $METRIC_VALUE (permanent)"
        nmcli connection modify "$conn" \
            ipv4.route-metric "$METRIC_VALUE" \
            ipv6.route-metric "$METRIC_VALUE"
        nmcli device reapply "$iface" >/dev/null 2>&1
    else
        echo "Setting $iface → metric $METRIC_VALUE (temporary)"
        sudo ifmetric "$iface" "$METRIC_VALUE"
    fi

    echo
    echo "Default routes:"
    ip route show default
}

# ─── Usage ───────────────────────────────────────────────────────────────────

usage() {
    cat <<EOF
Usage: enx <command> [options]

Commands:
  list                    List USB ethernet interfaces
  ip    [selector]        Get IP address of an interface
  pin-onboard             Fix onboard ethernet/wifi metrics (${ONBOARD_ETH_METRIC}/${ONBOARD_WIFI_METRIC})
  metric [selector] opts  Set metric for an interface

Selectors (for ip and metric):
  --name  <device_name>   Select by USB device name (case-insensitive)
  --id    <index>         Select by numeric index from list
  --iface <interface>     Select by interface name (e.g. enxaabbccddeeff)

Metric options:
  --value <metric>        Metric value to set
  --permanent             Use nmcli (survives reboot); default is ifmetric (temporary)

Examples:
  enx list
  enx ip
  enx ip --name lenovo
  enx pin-onboard
  enx metric --id 0 --value 500
  enx metric --name lenovo --value 1000 --permanent
EOF
}

# ─── Arg parsing ─────────────────────────────────────────────────────────────

[[ $# -eq 0 ]] && { usage; exit 0; }

COMMAND=""
SEL_NAME=""
SEL_ID=""
SEL_IFACE=""
METRIC_VALUE=""
PERMANENT=false

case "$1" in
    list|ip|pin-onboard|metric) COMMAND="$1"; shift ;;
    -h|--help)                  usage; exit 0 ;;
    *)                          echo "Unknown command: $1" >&2; usage; exit 1 ;;
esac

while [[ $# -gt 0 ]]; do
    case "$1" in
        --name)      shift; SEL_NAME="$1" ;;
        --id)        shift; SEL_ID="$1" ;;
        --iface)     shift; SEL_IFACE="$1" ;;
        --value)     shift; METRIC_VALUE="$1" ;;
        --permanent) PERMANENT=true ;;
        -h|--help)   usage; exit 0 ;;
        *)           echo "Unknown option: $1" >&2; usage; exit 1 ;;
    esac
    shift
done

# ─── Dispatch ────────────────────────────────────────────────────────────────

case "$COMMAND" in
    list)        cmd_list ;;
    ip)          cmd_ip ;;
    pin-onboard) cmd_pin_onboard ;;
    metric)      cmd_metric ;;
esac
