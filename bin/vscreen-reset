#!/bin/bash
# ============================
# vscreen-emergency-reset
# ============================
# Emergency recovery tool for broken display states
# Use from TTY (Ctrl+Alt+F2) or SSH when GDM shows black screen
#
# Usage:
#   vscreen-emergency-reset              # Disable all virtual displays
#   vscreen-emergency-reset --restart    # Also restart display manager
#   vscreen-emergency-reset --help
# ============================

set -euo pipefail

show_help() {
  cat << 'EOF'
vscreen-emergency-reset - Recover from broken display manager

This script forcefully disables all virtual displays and optionally
restarts your display manager. Use when:
- GDM/SDDM shows black screen after login
- Cannot switch to TTY normally
- vscreen --off-all doesn't work

USAGE:
  vscreen-emergency-reset              # Disable all VIRTUAL outputs
  vscreen-emergency-reset --restart    # Also restart display manager
  vscreen-emergency-reset --help       # Show this help

REQUIREMENTS:
  Must be run from:
  - TTY (Ctrl+Alt+F2-F6)
  - SSH session
  - NOT from graphical session

EXAMPLE:
  # After GDM black screen:
  1. Press Ctrl+Alt+F2 to switch to TTY
  2. Login with your username/password
  3. Run: vscreen-emergency-reset --restart
  4. Return to graphical session with Alt+F1 or Alt+F7

EOF
}

# Safety check: prevent running from graphical session
if [[ -n "${DISPLAY:-}" ]] && [[ -z "${SSH_CONNECTION:-}" ]]; then
  echo "âŒ ERROR: Do not run this from graphical session!"
  echo "Switch to TTY first with Ctrl+Alt+F2"
  exit 1
fi

# Parse arguments
RESTART_DM=false

case "${1:-}" in
  --help|-h)
    show_help
    exit 0
    ;;
  --restart|-r)
    RESTART_DM=true
    ;;
  "")
    # No arguments, just reset
    ;;
  *)
    echo "Unknown option: $1"
    show_help
    exit 1
    ;;
esac

echo "ðŸš¨ vscreen Emergency Reset"
echo "=========================="
echo ""

# Find all VIRTUAL outputs using DISPLAY=:0
echo "Looking for virtual displays..."
VIRTUALS=$(DISPLAY=:0 xrandr 2>/dev/null | awk '/^VIRTUAL[0-9]+/{print $1}' || true)

if [[ -z "$VIRTUALS" ]]; then
  echo "âœ“ No virtual displays found"
else
  echo "Found virtual displays:"
  echo "$VIRTUALS" | sed 's/^/  - /'
  echo ""
  echo "Disabling all virtual displays..."
  
  for v in $VIRTUALS; do
    echo "  Disabling $v..."
    DISPLAY=:0 xrandr --output "$v" --off 2>/dev/null || echo "    (failed, continuing...)"
  done
  
  echo "âœ“ All virtual displays disabled"
fi

echo ""

# Restart display manager if requested
if $RESTART_DM; then
  echo "Detecting display manager..."
  
  if systemctl is-active --quiet gdm; then
    DM="gdm"
  elif systemctl is-active --quiet sddm; then
    DM="sddm"
  elif systemctl is-active --quiet lightdm; then
    DM="lightdm"
  elif systemctl is-active --quiet display-manager; then
    DM="display-manager"
  else
    echo "âš  Could not detect display manager"
    echo "Manually restart with: sudo systemctl restart gdm"
    exit 1
  fi
  
  echo "Found: $DM"
  echo ""
  echo "âš  WARNING: This will restart the display manager!"
  echo "All graphical sessions will be terminated."
  echo ""
  read -p "Continue? (yes/no): " -r
  
  if [[ $REPLY =~ ^[Yy][Ee][Ss]$ ]]; then
    echo "Restarting display manager..."
    sudo systemctl restart "$DM"
    echo "âœ“ Display manager restarted"
    echo ""
    echo "You can now return to graphical session:"
    echo "  Press Alt+F1 or Alt+F7"
  else
    echo "Cancelled"
    exit 0
  fi
else
  echo "Virtual displays disabled."
  echo ""
  echo "If still having issues, run with --restart:"
  echo "  vscreen-emergency-reset --restart"
fi

echo ""
echo "âœ“ Emergency reset complete"