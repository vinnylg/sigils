#!/bin/bash

# gclip — GSConnect clipboard manager
# Push/pull clipboard between PC and paired devices via DBus

DEST="org.gnome.Shell.Extensions.GSConnect"
DEVICE_IFACE="org.gnome.Shell.Extensions.GSConnect.Device"
BASE_PATH="/org/gnome/Shell/Extensions/GSConnect/Device"

# ─── DBus helpers ────────────────────────────────────────────────────────────

_get_device_ids() {
    gdbus introspect --session \
        --dest "$DEST" \
        --object-path "$BASE_PATH" \
        --recurse 2>/dev/null \
        | grep -oP "${BASE_PATH}/\K[a-f0-9]+"
}

_get_str_prop() {
    local id="$1" prop="$2"
    gdbus call --session \
        --dest "$DEST" \
        --object-path "${BASE_PATH}/${id}" \
        --method org.freedesktop.DBus.Properties.Get \
        "$DEVICE_IFACE" "$prop" 2>/dev/null \
        | grep -oP "(?<=<')[^']+"
}

_get_bool_prop() {
    local id="$1" prop="$2"
    gdbus call --session \
        --dest "$DEST" \
        --object-path "${BASE_PATH}/${id}" \
        --method org.freedesktop.DBus.Properties.Get \
        "$DEVICE_IFACE" "$prop" 2>/dev/null \
        | grep -oP 'true|false'
}

_activate() {
    local id="$1" action="$2"
    gdbus call --session \
        --dest "$DEST" \
        --object-path "${BASE_PATH}/${id}" \
        --method org.gtk.Actions.Activate \
        "$action" [] {} 2>&1
}

# ─── Device resolution ───────────────────────────────────────────────────────

resolve_id() {
    local input="$1"
    local ids
    ids=$(_get_device_ids)

    if [[ ${#input} -lt 6 ]]; then
        echo "Error: ID prefix must be at least 6 characters" >&2
        return 1
    fi

    local match=""
    while IFS= read -r id; do
        if [[ "$id" == "$input"* ]]; then
            if [[ -n "$match" ]]; then
                echo "Error: ambiguous ID prefix '$input' matches multiple devices" >&2
                return 1
            fi
            match="$id"
        fi
    done <<< "$ids"

    if [[ -z "$match" ]]; then
        echo "Error: no device with ID matching '$input'" >&2
        return 1
    fi

    echo "$match"
}

resolve_id_by_name() {
    local target="$1"
    local ids
    ids=$(_get_device_ids)

    while IFS= read -r id; do
        local name
        name=$(_get_str_prop "$id" "Name")
        if [[ "$name" == "$target" ]]; then
            echo "$id"
            return 0
        fi
    done <<< "$ids"

    echo "Error: no device named '$target'" >&2
    return 1
}

# ─── Commands ────────────────────────────────────────────────────────────────

cmd_list() {
    local ids
    ids=$(_get_device_ids)

    if [[ -z "$ids" ]]; then
        echo "No devices found." >&2
        exit 1
    fi

    while IFS= read -r id; do
        local name connected paired
        name=$(_get_str_prop       "$id" "Name")
        connected=$(_get_bool_prop "$id" "Connected")
        paired=$(_get_bool_prop    "$id" "Paired")
        echo "$name"
        echo "  id:        $id"
        echo "  connected: $connected"
        echo "  paired:    $paired"
        echo
    done <<< "$ids"
}

cmd_push() {
    local device_id="$1"

    if $USE_TXT; then
        if [[ -n "$TXT_VALUE" ]]; then
            echo -n "$TXT_VALUE" | xclip -selection clipboard -i
        else
            xclip -selection clipboard -i
        fi
    fi

    local result
    result=$(_activate "$device_id" "clipboardPush")
    if [[ "$result" == "()" ]]; then
        local name
        name=$(_get_str_prop "$device_id" "Name")
        echo "push → $name" >&2
    else
        echo "Error: $result" >&2
        exit 1
    fi
}

cmd_pull() {
    local device_id="$1"

    local result
    result=$(_activate "$device_id" "clipboardPull")
    if [[ "$result" == "()" ]]; then
        local name
        name=$(_get_str_prop "$device_id" "Name")
        if $USE_TXT; then
            sleep 0.3
            xclip -selection clipboard -o
        else
            echo "pull ← $name" >&2
        fi
    else
        echo "Error: $result" >&2
        exit 1
    fi
}

# ─── Usage ───────────────────────────────────────────────────────────────────

usage() {
    cat <<EOF
Usage: gclip <command> [options]

Commands:
  list                 List paired devices
  push [opts]          Push clipboard PC → device
  pull [opts]          Pull clipboard device → PC

Options:
  --name <name>        Select device by exact name
  --id   <id>          Select device by full or partial ID (min 6 chars)
  --txt  [text]        Push: send text instead of clipboard (no arg = stdin)
                       Pull: print to stdout instead of clipboard
  -h, --help           Show this help

Examples:
  gclip list
  gclip push --name lenovo
  gclip push --name lenovo --txt "hello world"
  echo "hello" | gclip push --name lenovo --txt
  gclip pull --id bf088e
  gclip pull --name lenovo --txt
EOF
}

# ─── Arg parsing ─────────────────────────────────────────────────────────────

[[ $# -eq 0 ]] && { usage; exit 0; }

COMMAND=""
DEVICE_NAME=""
DEVICE_ID=""
USE_TXT=false
TXT_VALUE=""

# First positional arg is the command
case "$1" in
    list|push|pull) COMMAND="$1"; shift ;;
    -h|--help)      usage; exit 0 ;;
    *)              echo "Unknown command: $1" >&2; usage; exit 1 ;;
esac

while [[ $# -gt 0 ]]; do
    case "$1" in
        --name)
            shift
            DEVICE_NAME="$1"
            ;;
        --id)
            shift
            DEVICE_ID="$1"
            ;;
        --txt)
            USE_TXT=true
            if [[ $# -gt 1 && ! "$2" =~ ^- ]]; then
                shift
                TXT_VALUE="$1"
            fi
            ;;
        -h|--help)
            usage; exit 0
            ;;
        *)
            echo "Unknown option: $1" >&2
            usage; exit 1
            ;;
    esac
    shift
done

# ─── Dispatch ────────────────────────────────────────────────────────────────

if [[ "$COMMAND" == "list" ]]; then
    cmd_list
    exit 0
fi

# push and pull require a device
if [[ -n "$DEVICE_NAME" ]]; then
    DEVICE_ID=$(resolve_id_by_name "$DEVICE_NAME") || exit 1
elif [[ -n "$DEVICE_ID" ]]; then
    DEVICE_ID=$(resolve_id "$DEVICE_ID") || exit 1
else
    echo "Error: specify --name or --id" >&2
    usage; exit 1
fi

case "$COMMAND" in
    push) cmd_push "$DEVICE_ID" ;;
    pull) cmd_pull "$DEVICE_ID" ;;
esac
